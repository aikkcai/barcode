<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <title>条形码扫描工具（修复黑屏版）</title>
    <!-- ZXing 核心库 -->
    <script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.21.1/dist/zxing.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: sans-serif; }
        body { padding: 1rem; background: #f5f5f5; text-align: center; }
        h1 { font-size: 1.5rem; color: #333; margin-bottom: 1rem; }
        
        #video-container {
            width: 90%;
            max-width: 500px;
            height: 300px;
            margin: 0 auto 1rem;
            border: 3px solid #2c7be5;
            border-radius: 8px;
            overflow: hidden;
            background: #000;
            position: relative;
        }
        
        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1); /* 修复部分安卓摄像头镜像问题 */
        }
        
        .scan-line {
            position: absolute;
            top: 40%;
            left: 10%;
            width: 80%;
            height: 2px;
            background: #00ff00;
            box-shadow: 0 0 10px #00ff00;
            animation: scan 2s linear infinite;
        }
        
        @keyframes scan {
            0% { top: 20%; }
            50% { top: 80%; }
            100% { top: 20%; }
        }
        
        #result {
            width: 90%;
            max-width: 500px;
            margin: 0 auto 1rem;
            padding: 1rem;
            background: #fff;
            border-radius: 8px;
            border: 1px solid #eee;
            min-height: 40px;
            font-size: 1rem;
            color: #333;
            word-break: break-all;
        }
        
        .control-btn {
            padding: 0.8rem 1.5rem;
            margin: 0 0.3rem 1rem;
            border: none;
            border-radius: 4px;
            color: #fff;
            cursor: pointer;
            font-size: 1rem;
        }
        
        #start-scan { background: #2c7be5; }
        #stop-scan { background: #e53e3e; }
        #switch-camera { background: #6c757d; }
        button:disabled { opacity: 0.6; cursor: not-allowed; }
    </style>
</head>
<body>
    <h1>条形码扫描工具V4.0</h1>
    <div id="video-container">
        <video id="video" autoplay playsinline muted></video>
        <div class="scan-line"></div>
    </div>
    
    <button id="start-scan" class="control-btn">开始扫描</button>
    <button id="stop-scan" class="control-btn" disabled>停止扫描</button>
    <button id="switch-camera" class="control-btn" disabled>切换摄像头</button>
    
    <div id="result">等待扫描...</div>

    <script>
        // 全局变量
        const codeReader = new ZXing.BrowserBarcodeReader();
        let isScanning = false;
        let currentStream = null;
        let useFrontCamera = false; // 默认后置
        
        // DOM 元素
        const video = document.getElementById('video');
        const resultEl = document.getElementById('result');
        const startBtn = document.getElementById('start-scan');
        const stopBtn = document.getElementById('stop-scan');
        const switchBtn = document.getElementById('switch-camera');

        // 核心：获取摄像头流（兼容所有机型）
        async function getCameraStream() {
            try {
                // 兼容iOS/安卓的摄像头配置
                const facingMode = useFrontCamera ? 'user' : 'environment';
                const constraints = {
                    video: {
                        facingMode: { ideal: facingMode }, // 用ideal而非exact，避免强制失败
                        width: { ideal: 1280, max: 1920 },
                        height: { ideal: 720, max: 1080 },
                        frameRate: { ideal: 30, min: 15 }
                    },
                    audio: false // 禁用音频，避免额外权限请求
                };

                // 获取摄像头流
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                currentStream = stream;
                return stream;
            } catch (err) {
                throw new Error(`摄像头调用失败：${err.message}`);
            }
        }

        // 开始扫描
        startBtn.addEventListener('click', async () => {
            if (isScanning) return;
            
            try {
                // 1. 获取摄像头流
                const stream = await getCameraStream();
                // 2. 绑定到video标签（关键：先清空再赋值）
                video.srcObject = null;
                video.srcObject = stream;
                
                // 3. 等待video加载完成后再启动识别（解决黑屏核心）
                video.onloadedmetadata = async () => {
                    await video.play(); // 手动触发播放，兼容iOS
                    
                    // 4. 启动ZXing识别
                    codeReader.decodeFromVideoElement(
                        undefined,
                        video,
                        (resultObj, err) => {
                            if (resultObj) {
                                // 识别成功
                                resultEl.textContent = `扫描成功：${resultObj.text}`;
                                resultEl.style.color = '#28a745';
                                // 可选：识别后自动停止
                                // stopScan();
                            }
                            if (err && !err.isNotFound) {
                                // 非“未找到条码”的真实错误
                                resultEl.textContent = `识别提示：${err.message}`;
                                resultEl.style.color = '#666';
                            }
                        }
                    );

                    // 更新状态
                    isScanning = true;
                    startBtn.disabled = true;
                    stopBtn.disabled = false;
                    switchBtn.disabled = false;
                    resultEl.textContent = "扫描中，请将条形码对准摄像头（绿色扫描线区域）";
                    resultEl.style.color = "#333";
                };
            } catch (err) {
                // 错误提示（比如权限拒绝、无摄像头）
                resultEl.textContent = err.message;
                resultEl.style.color = '#e53e3e';
            }
        });

        // 停止扫描
        stopBtn.addEventListener('click', () => {
            if (!isScanning) return;
            
            // 1. 停止识别
            codeReader.reset();
            // 2. 停止摄像头流
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
            }
            // 3. 清空video
            video.srcObject = null;
            // 4. 更新状态
            isScanning = false;
            startBtn.disabled = false;
            stopBtn.disabled = true;
            switchBtn.disabled = true;
            resultEl.textContent = "已停止扫描，点击「开始扫描」重新启动";
            resultEl.style.color = "#333";
        });

        // 切换摄像头（前置/后置）
        switchBtn.addEventListener('click', async () => {
            if (!isScanning) return;
            
            // 1. 先停止当前流
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
            }
            // 2. 切换摄像头标识
            useFrontCamera = !useFrontCamera;
            // 3. 重新获取流并启动
            try {
                const newStream = await getCameraStream();
                video.srcObject = newStream;
                currentStream = newStream;
                resultEl.textContent = `已切换到${useFrontCamera ? '前置' : '后置'}摄像头，继续扫描...`;
            } catch (err) {
                resultEl.textContent = `切换摄像头失败：${err.message}`;
                resultEl.style.color = '#e53e3e';
            }
        });

        // 页面关闭时释放资源
        window.addEventListener('beforeunload', () => {
            if (isScanning) {
                codeReader.reset();
                currentStream?.getTracks().forEach(track => track.stop());
            }
        });
    </script>
</body>
</html>
