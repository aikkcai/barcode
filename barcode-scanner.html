<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>条形码扫描工具（ZXing版）</title>
    <!-- 引入 ZXing-js 核心库 -->
    <script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/index.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: sans-serif;
        }
        body {
            padding: 1rem;
            background: #f5f5f5;
            text-align: center;
        }
        h1 {
            font-size: 1.5rem;
            color: #333;
            margin-bottom: 1rem;
        }
        #video-container {
            width: 90%;
            max-width: 500px;
            height: 300px;
            margin: 0 auto 1rem;
            border: 3px solid #2c7be5;
            border-radius: 8px;
            overflow: hidden;
            background: #000;
            position: relative;
        }
        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .scan-line {
            position: absolute;
            top: 40%;
            left: 10%;
            width: 80%;
            height: 2px;
            background: #00ff00;
            box-shadow: 0 0 10px #00ff00;
            animation: scan 2s linear infinite;
        }
        @keyframes scan {
            0% { top: 20%; }
            50% { top: 80%; }
            100% { top: 20%; }
        }
        #result {
            width: 90%;
            max-width: 500px;
            margin: 0 auto 1rem;
            padding: 1rem;
            background: #fff;
            border-radius: 8px;
            border: 1px solid #eee;
            min-height: 40px;
            font-size: 1rem;
            color: #333;
            word-break: break-all;
        }
        .control-btn {
            padding: 0.8rem 1.5rem;
            margin: 0 0.3rem;
            border: none;
            border-radius: 4px;
            color: #fff;
            cursor: pointer;
        }
        #start-scan { background: #2c7be5; }
        #stop-scan { background: #e53e3e; }
    </style>
</head>
<body>
    <h1>条形码扫描工具V3.0</h1>
    <div id="video-container">
        <video id="video" autoplay playsinline muted></video>
        <div class="scan-line"></div>
    </div>
    <button id="start-scan" class="control-btn">开始扫描</button>
    <button id="stop-scan" class="control-btn" disabled>停止扫描</button>
    <div id="result">等待扫描...</div>

    <script>
        const codeReader = new ZXing.BrowserBarcodeReader();
        let isScanning = false;
        const video = document.getElementById('video');
        const result = document.getElementById('result');
        const startBtn = document.getElementById('start-scan');
        const stopBtn = document.getElementById('stop-scan');

        // 开始扫描
        startBtn.addEventListener('click', async () => {
            if (isScanning) return;
            try {
                // 优先调用后置摄像头
                const constraints = {
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;

                // 启动识别
                codeReader.decodeFromVideoElement(
                    undefined, 
                    video, 
                    (resultObj, err) => {
                        if (resultObj) {
                            // 识别成功
                            result.textContent = `扫描成功：${resultObj.text}`;
                            result.style.color = '#28a745';
                            // 可选：识别后自动停止
                            // stopScan();
                        }
                        if (err && !err.isNotFound) {
                            result.textContent = `识别错误：${err.message}`;
                            result.style.color = '#e53e3e';
                        }
                    }
                );

                isScanning = true;
                startBtn.disabled = true;
                stopBtn.disabled = false;
                result.textContent = "扫描中，请将条形码对准摄像头";
                result.style.color = "#333";
            } catch (err) {
                result.textContent = `摄像头启动失败：${err.message}`;
                result.style.color = '#e53e3e';
            }
        });

        // 停止扫描
        stopBtn.addEventListener('click', () => {
            if (!isScanning) return;
            codeReader.reset();
            const stream = video.srcObject;
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            video.srcObject = null;
            isScanning = false;
            startBtn.disabled = false;
            stopBtn.disabled = true;
            result.textContent = "已停止扫描";
        });

        // 页面关闭时释放资源
        window.addEventListener('beforeunload', () => {
            if (isScanning) {
                codeReader.reset();
                const stream = video.srcObject;
                stream?.getTracks().forEach(track => track.stop());
            }
        });
    </script>
</body>
</html>
