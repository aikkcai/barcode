<!DOCTYPE html>
<html lang="ja">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=0.1, maximum-scale=4,user-scalable=yes">
<!-- quaggaJSの読み込み -->
<script src="https://cdn.rawgit.com/serratus/quaggaJS/0420d5e0/dist/quagga.min.js"></script>
<style>
/* 基础样式：确保布局清晰 */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}
body {
  padding: 10px;
  font-family: Arial, sans-serif;
}
/* 识别类型选择框 */
.type-select {
  margin: 10px 0;
  font-size: 14px;
}
/* 摄像头画布：强制显示，避免消失 */
#preview {
  border: 1px solid #ccc;
  min-width: 320px;
  min-height: 240px;
  margin: 10px 0;
  display: block !important;
}
/* 目标条码表格样式（两列：序号+条码） */
#targetBarcodeTable {
  width: 100%;
  border-collapse: collapse;
  margin: 15px 0;
  font-size: 14px; /* 放大字体，更易读 */
}
#targetBarcodeTable th,
#targetBarcodeTable td {
  border: 1px solid #ddd;
  padding: 8px 10px;
  text-align: center;
  transition: background-color 0.2s ease; /* 过渡效果让闪烁更平滑 */
}
#targetBarcodeTable th {
  background-color: #f8f9fa;
  font-weight: bold;
}
/* 序号列宽度固定 */
#targetBarcodeTable td:first-child {
  width: 80px;
  color: #666;
}
/* 条码列占满剩余宽度 */
#targetBarcodeTable td:last-child {
  width: calc(100% - 80px);
}
/* 匹配高亮：黄色背景（永久） */
#targetBarcodeTable tr.highlight td {
  background-color: #fff3cd !important;
  font-weight: bold;
  color: #d63384;
}
/* 闪烁效果类：红色背景（临时） */
#targetBarcodeTable tr.flash td {
  background-color: #ffcccc !important;
}
/* 结果文本域 */
#jan {
  width: 100%;
  min-height: 100px;
  padding: 8px;
  margin-top: 10px;
}
h4 {
  margin: 10px 0 5px 0;
  font-size: 15px;
}
/* 复制按钮样式 */
#copyTableBtn {
  padding: 8px 16px;
  background-color: #007bff;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px;
  margin: 10px 0;
}
#copyTableBtn:hover {
  background-color: #0056b3;
}
#copyTableBtn:active {
  background-color: #004085;
}
/* 复制提示样式 */
.copy-toast {
  position: fixed;
  top: 20px;
  right: 20px;
  background-color: #28a745;
  color: white;
  padding: 8px 16px;
  border-radius: 4px;
  font-size: 14px;
  opacity: 0;
  transition: opacity 0.3s ease;
  z-index: 9999;
}
.copy-toast.show {
  opacity: 1;
}
</style>
<script>
var DetectedCount=0,DetectedCode="";
var video,tmp,tmp_ctx,jan,prev,prev_ctx,w,h,mw,mh,x1,y1;
var currentReader = "code_128_reader";
var audioContext;
// ========== 新增：存储已识别的条码，避免重复 ==========
var scannedCodes = new Set();

window.addEventListener('load',function(event){
  // 获取核心元素
  prev=document.getElementById("preview");
  jan=document.getElementById("jan");
  
  // 创建识别类型选择框
  createBarcodeTypeSelect();

  // ========== 新增：创建复制表格按钮 ==========
  createCopyTableButton();

  // 初始化音频
  initAudioContext();

  // 初始化画布上下文
  prev_ctx=prev.getContext("2d", {willReadFrequently:true});
  tmp = document.createElement('canvas');
  tmp_ctx = tmp.getContext("2d", {willReadFrequently:true});

  // 初始化视频
  video=document.createElement('video');
  video.setAttribute("autoplay","");
  video.setAttribute("muted","");
  video.setAttribute("playsinline","");
  video.onloadedmetadata = function(e){video.play();};

  // 请求摄像头权限
  navigator.mediaDevices.getUserMedia(
    {"audio":false,"video":{"facingMode":"environment","width":{"ideal":640},"height":{"ideal":480}}}
  ).then(function(stream){
    video.srcObject = stream;
    setTimeout(Scan,500,true);
  }).catch(function(err){
    jan.value+=err+'\n';
  });

  // 扫描函数
  function Scan(first){
    if(first){
      w=video.videoWidth || 640; // 兜底尺寸
      h=video.videoHeight || 480;
      prev.style.width = (w/2) + "px";
      prev.style.height = (h/2) + "px";
      prev.width = w;
      prev.height = h;
      mw=w*0.5;
      mh=w*0.2;
      x1=(w-mw)/2;
      y1=(h-mh)/2;
    }
    // 绘制摄像头画面
    prev_ctx.drawImage(video,0,0,w,h);
    // 绘制扫描框
    prev_ctx.beginPath();
    prev_ctx.strokeStyle="rgb(255,0,0)";
    prev_ctx.lineWidth=2;
    prev_ctx.rect(x1,y1,mw,mh);
    prev_ctx.stroke();

    // 裁剪识别区域
    tmp.width=mw;
    tmp.height=mh;
    tmp_ctx.drawImage(prev,x1,y1,mw,mh,0,0,mw,mh);

    tmp.toBlob(function(blob){
      let reader = new FileReader();
      reader.onload=function(){
        let config={
          decoder: {
            readers: [currentReader],
            multiple: false,
          },
          locator:{patchSize:"large",halfSample:false},
          locate:false,
          src:reader.result,
        };
        Quagga.decodeSingle(config,function(){});
      }
      reader.readAsDataURL(blob);
    });
    setTimeout(Scan,50,false);
  }

  // 识别结果处理
  Quagga.onDetected(function (result) {
    const currentCode = result.codeResult.code;
    
    // ========== 关键修改：检查是否已识别过该条码 ==========
    if (scannedCodes.has(currentCode)) {
      playBeepSound();
      return; // 如果已识别过，直接返回，不处理
    }

    if(DetectedCode==currentCode){
      DetectedCount++;
    }else{
      DetectedCount=0;
      DetectedCode=currentCode;
    }
    if(DetectedCount>=3){
      // 查找匹配行并获取序号
      const targetRow = document.querySelector(`#targetBarcodeTable tr[data-code="${currentCode}"]`);
      let displayText = currentCode;
      if (targetRow) {
        // 获取序号列的文本内容
        const serialNumber = targetRow.querySelector('td:first-child').textContent;
        displayText = `${currentCode} 序號: ${serialNumber}`;
      }
      // 写入文本域
      jan.value+=displayText+'\n';
      jan.scrollTop=jan.scrollHeight;
      
      // 高亮+闪烁HTML表格中匹配的条码行
      highlightAndFlashBarcode(currentCode);
      // 播放提示音+粤语播报
      playBeepSound();
      speakCantonese(currentCode);

      // ========== 关键修改：将识别过的条码加入集合 ==========
      scannedCodes.add(currentCode);

      DetectedCode='';
      DetectedCount=0;
    }
  });

  // 创建识别类型选择框
  function createBarcodeTypeSelect() {
    const selectDiv = document.createElement('div');
    selectDiv.className = 'type-select';
    selectDiv.innerHTML = `
      <h4>选择识别类型</h4>
      <label style="margin-right:10px;">
        <input type="radio" name="barcodeType" value="code_128_reader" checked> Code128
      </label>
      <label style="margin-right:10px;">
        <input type="radio" name="barcodeType" value="ean_reader"> EAN-13
      </label>
      <label>
        <input type="radio" name="barcodeType" value="ean_8_reader"> EAN-8
      </label>
    `;
    document.body.insertBefore(selectDiv, document.body.firstChild);

    document.querySelectorAll('input[name="barcodeType"]').forEach(radio => {
      radio.addEventListener('change', function() {
        currentReader = this.value;
        DetectedCount=0;
        DetectedCode="";
      });
    });
  }

  // ========== 新增：创建复制表格按钮 ==========
  function createCopyTableButton() {
    // 创建按钮容器
    const btnContainer = document.createElement('div');
    btnContainer.style.margin = '10px 0';
    
    // 创建复制按钮
    const copyBtn = document.createElement('button');
    copyBtn.id = 'copyTableBtn';
    copyBtn.textContent = '复制条码表格';
    copyBtn.addEventListener('click', copyTableContent);
    
    // 创建提示框
    const toast = document.createElement('div');
    toast.className = 'copy-toast';
    toast.textContent = '表格内容已复制！';
    document.body.appendChild(toast);
    
    btnContainer.appendChild(copyBtn);
    
    // 插入到表格上方
    const table = document.getElementById('targetBarcodeTable');
    table.parentNode.insertBefore(btnContainer, table);
  }

  // ========== 新增：复制表格内容函数 ==========
  function copyTableContent() {
    const table = document.getElementById('targetBarcodeTable');
    let tableText = '序号\t条码\n'; // 制表符分隔，方便粘贴到Excel
    
    // 遍历表格行
    const rows = table.querySelectorAll('tbody tr');
    rows.forEach(row => {
      const serial = row.querySelector('td:first-child').textContent.trim();
      const code = row.querySelector('td:last-child').textContent.trim();
      tableText += `${serial}\t${code}\n`;
    });
    
    // 复制到剪贴板
    navigator.clipboard.writeText(tableText)
      .then(() => {
        // 显示提示
        const toast = document.querySelector('.copy-toast');
        toast.classList.add('show');
        setTimeout(() => {
          toast.classList.remove('show');
        }, 2000);
      })
      .catch(err => {
        console.error('复制失败:', err);
        jan.value += '复制表格失败：' + err + '\n';
      });
  }

  // 高亮+闪烁匹配的行：先闪红色，再保持黄色高亮
  function highlightAndFlashBarcode(code) {
    // 查找HTML表格中对应data-code的行
    const targetRow = document.querySelector(`#targetBarcodeTable tr[data-code="${code}"]`);
    if (targetRow) {
      // 1. 添加闪烁类（红色背景）
      targetRow.classList.add('flash');
      // 2. 0.3秒后移除闪烁类，添加永久高亮类（黄色背景）
      setTimeout(() => {
        targetRow.classList.remove('flash');
        targetRow.classList.add('highlight');
      }, 300);
    }
  }

  // 音频相关函数
  function initAudioContext() {
    try {
      window.AudioContext = window.AudioContext || window.webkitAudioContext;
      audioContext = new AudioContext();
    } catch (e) {
      console.warn("音频功能不支持：", e);
    }
  }

  function playBeepSound() {
    if (!audioContext) return;
    
    if (audioContext.state === 'suspended') {
      audioContext.resume();
    }

    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    oscillator.type = 'sine';
    oscillator.frequency.setValueAtTime(440, audioContext.currentTime);
    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
    
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    oscillator.start();
    oscillator.stop(audioContext.currentTime + 0.1);
  }

  function speakCantonese(code) {
    if (!('speechSynthesis' in window)) {
      console.warn("语音合成不支持");
      return;
    }

    window.speechSynthesis.cancel();

    const utterance = new SpeechSynthesisUtterance();
    utterance.text = `识别到条码：${code}`;
    utterance.lang = 'yue-HK';
    utterance.volume = 1;
    utterance.rate = 0.9;
    utterance.pitch = 1;

    window.speechSynthesis.speak(utterance);
  }
});
</script>
</head>
<body>
  <!-- 识别类型选择框会通过JS插入到这里（最顶部） -->
  
  <!-- 摄像头画布 -->
  <canvas id="preview"></canvas>
  <!-- 识别结果文本域 -->
  <textarea id="jan" rows="8" cols="40" placeholder="识别到的条码会显示在这里..."></textarea>
  <!-- 目标条码表格：按指定序号和条码对应 -->
  <h4>目标条码列表（识别匹配后先闪红再变黄）</h4>
  <table id="targetBarcodeTable">
    <thead>
      <tr>
        <th>序号</th>
        <th>条码</th>
      </tr>
    </thead>
    <tbody>
      <tr data-code="P005849"><td>3</td><td>P005849</td></tr>
      <tr data-code="0019885"><td>4</td><td>0019885</td></tr>
      <tr data-code="0020554"><td>5</td><td>0020554</td></tr>
      <tr data-code="0020560"><td>6</td><td>0020560</td></tr>
      <tr data-code="0025095"><td>7</td><td>0025095</td></tr>
      <tr data-code="0021609"><td>8</td><td>0021609</td></tr>
      <tr data-code="0025091"><td>9</td><td>0025091</td></tr>
      <tr data-code="0025111"><td>10</td><td>0025111</td></tr>
      <tr data-code="0030830"><td>11</td><td>0030830</td></tr>
      <tr data-code="0033390"><td>12</td><td>0033390</td></tr>
      <tr data-code="0033393"><td>13</td><td>0033393</td></tr>
      <tr data-code="0036973"><td>14</td><td>0036973</td></tr>
      <tr data-code="0036974"><td>15</td><td>0036974</td></tr>
      <tr data-code="0025115"><td>16</td><td>0025115</td></tr>
      <tr data-code="0025122"><td>17</td><td>0025122</td></tr>
      <tr data-code="0030827"><td>21</td><td>0030827</td></tr>
      <tr data-code="0033384"><td>22</td><td>0033384</td></tr>
      <tr data-code="0025116"><td>23</td><td>0025116</td></tr>
      <tr data-code="0025126"><td>24</td><td>0025126</td></tr>
      <tr data-code="0025127"><td>25</td><td>0025127</td></tr>
      <tr data-code="0020417"><td>26</td><td>0020417</td></tr>
      <tr data-code="0020418"><td>27</td><td>0020418</td></tr>
      <tr data-code="0020419"><td>28</td><td>0020419</td></tr>
      <tr data-code="0020420"><td>29</td><td>0020420</td></tr>
      <tr data-code="0020421"><td>30</td><td>0020421</td></tr>
      <tr data-code="0020422"><td>31</td><td>0020422</td></tr>
      <tr data-code="0020423"><td>32</td><td>0020423</td></tr>
      <tr data-code="0020424"><td>33</td><td>0020424</td></tr>
      <tr data-code="0020425"><td>34</td><td>0020425</td></tr>
      <tr data-code="0020426"><td>35</td><td>0020426</td></tr>
      <tr data-code="0020427"><td>36</td><td>0020427</td></tr>
      <tr data-code="0020428"><td>37</td><td>0020428</td></tr>
      <tr data-code="0020430"><td>38</td><td>0020430</td></tr>
      <tr data-code="0020431"><td>39</td><td>0020431</td></tr>
      <tr data-code="0020432"><td>40</td><td>0020432</td></tr>
      <tr data-code="0020433"><td>41</td><td>0020433</td></tr>
      <tr data-code="0020434"><td>42</td><td>0020434</td></tr>
      <tr data-code="0020435"><td>43</td><td>0020435</td></tr>
      <tr data-code="0020437"><td>44</td><td>0020437</td></tr>
      <tr data-code="0020438"><td>45</td><td>0020438</td></tr>
      <tr data-code="0022517"><td>46</td><td>0022517</td></tr>
      <tr data-code="0022518"><td>47</td><td>0022518</td></tr>
      <tr data-code="0022519"><td>48</td><td>0022519</td></tr>
      <tr data-code="0022520"><td>49</td><td>0022520</td></tr>
      <tr data-code="0022521"><td>50</td><td>0022521</td></tr>
      <tr data-code="0022522"><td>51</td><td>0022522</td></tr>
      <tr data-code="0022523"><td>52</td><td>0022523</td></tr>
      <tr data-code="0044713"><td>54</td><td>0044713</td></tr>
      <tr data-code="0044714"><td>55</td><td>0044714</td></tr>
      <tr data-code="0033632"><td>56</td><td>0033632</td></tr>
      <tr data-code="0033630"><td>57</td><td>0033630</td></tr>
      <tr data-code="0034128"><td>58</td><td>0034128</td></tr>
      <tr data-code="0026156"><td>59</td><td>0026156</td></tr>
      <tr data-code="0033627"><td>60</td><td>0033627</td></tr>
      <tr data-code="0033624"><td>61</td><td>0033624</td></tr>
      <tr data-code="0033623"><td>62</td><td>0033623</td></tr>
      <tr data-code="0033640"><td>63</td><td>0033640</td></tr>
      <tr data-code="0033638"><td>64</td><td>0033638</td></tr>
      <tr data-code="0033637"><td>65</td><td>0033637</td></tr>
      <tr data-code="0036503"><td>66</td><td>0036503</td></tr>
      <tr data-code="0036504"><td>67</td><td>0036504</td></tr>
      <tr data-code="0036505"><td>68</td><td>0036505</td></tr>
      <tr data-code="0036506"><td>69</td><td>0036506</td></tr>
      <tr data-code="0036287"><td>70</td><td>0036287</td></tr>
      <tr data-code="0036288"><td>71</td><td>0036288</td></tr>
      <tr data-code="0036286"><td>72</td><td>0036286</td></tr>
      <tr data-code="0036289"><td>73</td><td>0036289</td></tr>
      <tr data-code="0036875"><td>74</td><td>0036875</td></tr>
      <tr data-code="0036876"><td>75</td><td>0036876</td></tr>
      <tr data-code="0036074"><td>76</td><td>0036074</td></tr>
      <tr data-code="0036051"><td>77</td><td>0036051</td></tr>
      <tr data-code="0026361"><td>78</td><td>0026361</td></tr>
      <tr data-code="0026362"><td>79</td><td>0026362</td></tr>
      <tr data-code="0031385"><td>80</td><td>0031385</td></tr>
      <tr data-code="0031846"><td>81</td><td>0031846</td></tr>
      <tr data-code="0031845"><td>82</td><td>0031845</td></tr>
      <tr data-code="0036748"><td>83</td><td>0036748</td></tr>
      <tr data-code="0032217"><td>84</td><td>0032217</td></tr>
      <tr data-code="0032469"><td>85</td><td>0032469</td></tr>
      <tr data-code="0036068"><td>86</td><td>0036068</td></tr>
      <tr data-code="0019141"><td>87</td><td>0019141</td></tr>
      <tr data-code="0019145"><td>88</td><td>0019145</td></tr>
      <tr data-code="0019147"><td>89</td><td>0019147</td></tr>
      <tr data-code="0019148"><td>90</td><td>0019148</td></tr>
      <tr data-code="0021619"><td>91</td><td>0021619</td></tr>
      <tr data-code="0021620"><td>92</td><td>0021620</td></tr>
      <tr data-code="0017643"><td>93</td><td>0017643</td></tr>
      <tr data-code="0019944"><td>94</td><td>0019944</td></tr>
      <tr data-code="0031167"><td>95</td><td>0031167</td></tr>
      <tr data-code="0031168"><td>96</td><td>0031168</td></tr>
      <tr data-code="0031175"><td>97</td><td>0031175</td></tr>
      <tr data-code="0031155"><td>98</td><td>0031155</td></tr>
      <tr data-code="0031149"><td>99</td><td>0031149</td></tr>
      <tr data-code="0031170"><td>100</td><td>0031170</td></tr>
      <tr data-code="0027946"><td>102</td><td>0027946</td></tr>
      <tr data-code="0027948"><td>103</td><td>0027948</td></tr>
      <tr data-code="0031221"><td>104</td><td>0031221</td></tr>
      <tr data-code="0033396"><td>105</td><td>0033396</td></tr>
      <tr data-code="0033397"><td>106</td><td>0033397</td></tr>
      <tr data-code="0033398"><td>107</td><td>0033398</td></tr>
      <tr data-code="0031851"><td>108</td><td>0031851</td></tr>
      <tr data-code="0031852"><td>109</td><td>0031852</td></tr>
      <tr data-code="0018142"><td>110</td><td>0018142</td></tr>
      <tr data-code="0024848"><td>111</td><td>0024848</td></tr>
      <tr data-code="0024849"><td>112</td><td>0024849</td></tr>
      <tr data-code="0024854"><td>113</td><td>0024854</td></tr>
      <tr data-code="0024855"><td>114</td><td>0024855</td></tr>
      <tr data-code="0024856"><td>115</td><td>0024856</td></tr>
      <tr data-code="0022287"><td>116</td><td>0022287</td></tr>
      <tr data-code="0036279"><td>118</td><td>0036279</td></tr>
      <tr data-code="0036280"><td>119</td><td>0036280</td></tr>
      <tr data-code="P005403"><td>120</td><td>P005403</td></tr>
      <tr data-code="P005440"><td>121</td><td>P005440</td></tr>
      <tr data-code="P005448"><td>122</td><td>P005448</td></tr>
      <tr data-code="P005438"><td>123</td><td>P005438</td></tr>
      <tr data-code="P005481"><td>124</td><td>P005481</td></tr>
      <tr data-code="P005496"><td>125</td><td>P005496</td></tr>
      <tr data-code="P005502"><td>126</td><td>P005502</td></tr>
      <tr data-code="0026679"><td>127</td><td>0026679</td></tr>
      <tr data-code="0031703"><td>128</td><td>0031703</td></tr>
      <tr data-code="0031758"><td>129</td><td>0031758</td></tr>
      <tr data-code="0031727"><td>130</td><td>0031727</td></tr>
      <tr data-code="0031698"><td>131</td><td>0031698</td></tr>
      <tr data-code="0017591"><td>132</td><td>0017591</td></tr>
      <tr data-code="0020782"><td>133</td><td>0020782</td></tr>
      <tr data-code="0022318"><td>134</td><td>0022318</td></tr>
      <tr data-code="0036282"><td>135</td><td>0036282</td></tr>
      <tr data-code="0036283"><td>136</td><td>0036283</td></tr>
      <tr data-code="0036284"><td>137</td><td>0036284</td></tr>
      <tr data-code="0019954"><td>138</td><td>0019954</td></tr>
      <tr data-code="0020750"><td>139</td><td>0020750</td></tr>
      <tr data-code="0023739"><td>140</td><td>0023739</td></tr>
      <tr data-code="0023740"><td>141</td><td>0023740</td></tr>
      <tr data-code="0018144"><td>142</td><td>0018144</td></tr>
      <tr data-code="0019953"><td>143</td><td>0019953</td></tr>
      <tr data-code="0022234"><td>144</td><td>0022234</td></tr>
      <tr data-code="0022235"><td>145</td><td>0022235</td></tr>
      <tr data-code="0026356"><td>146</td><td>0026356</td></tr>
      <tr data-code="L002365"><td>147</td><td>L002365</td></tr>
      <tr data-code="0032130"><td>148</td><td>0032130</td></tr>
      <tr data-code="0033512"><td>149</td><td>0033512</td></tr>
      <tr data-code="0036310"><td>150</td><td>0036310</td></tr>
      <tr data-code="0033633"><td>151</td><td>0033633</td></tr>
      <tr data-code="0022275"><td>152</td><td>0022275</td></tr>
      <tr data-code="0022276"><td>153</td><td>0022276</td></tr>
      <tr data-code="0015684"><td>154</td><td>0015684</td></tr>
      <tr data-code="0022324"><td>155</td><td>0022324</td></tr>
      <tr data-code="0022333"><td>156</td><td>0022333</td></tr>
      <tr data-code="0032135"><td>157</td><td>0032135</td></tr>
      <tr data-code="0032136"><td>158</td><td>0032136</td></tr>
    </tbody>
  </table>
</body>
</html>

