<!DOCTYPE html>
<html lang="ja">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=0.1, maximum-scale=4,user-scalable=yes">
<!-- quaggaJSの読み込み -->
<script src="https://cdn.rawgit.com/serratus/quaggaJS/0420d5e0/dist/quagga.min.js"></script>
<script>
// 1. 重构变量：新增已识别条码集合、当前识别缓存（按条码分组计数）
var scannedCodes = new Set(); // 已识别的条码（去重）
var codeCounter = {}; // 每个条码的连续识别计数 { "123456": 2, "789012": 1 }
var video, tmp, tmp_ctx, jan, prev, prev_ctx, w, h, mw, mh, x1, y1;

window.addEventListener('load',function(event){
  video=document.createElement('video');
  video.setAttribute("autoplay","");
  video.setAttribute("muted","");
  video.setAttribute("playsinline","");
  video.onloadedmetadata = function(e){video.play();};
  prev=document.getElementById("preview");
  prev_ctx=prev.getContext("2d", {willReadFrequently:true});
  tmp = document.createElement('canvas');
  tmp_ctx = tmp.getContext("2d", {willReadFrequently:true});
  jan=document.getElementById("jan");

  // カメラ権限リクエスト
  navigator.mediaDevices.getUserMedia(
    {"audio":false,"video":{"facingMode":"environment","width":{"ideal":640},"height":{"ideal":480}}}
  ).then(function(stream){
    video.srcObject = stream;
    setTimeout(Scan,500,true);
  }).catch(function(err){
    jan.value += "カメラ権限エラー：" + err + '\n';
  });

  function Scan(first){
    if(first){
      w=video.videoWidth;
      h=video.videoHeight;
      prev.style.width=(w/2)+"px";
      prev.style.height=(h/2)+"px";
      prev.setAttribute("width",w);
      prev.setAttribute("height",h);
      mw=w*0.5;
      mh=w*0.2;
      x1=(w-mw)/2;
      y1=(h-mh)/2;
    }
    // 描画カメラ画面とスキャン枠
    prev_ctx.drawImage(video,0,0,w,h);
    prev_ctx.beginPath();
    prev_ctx.strokeStyle="rgb(255,0,0)";
    prev_ctx.lineWidth=2;
    prev_ctx.rect(x1,y1,mw,mh);
    prev_ctx.stroke();
    tmp.setAttribute("width",mw);
    tmp.setAttribute("height",mh);
    tmp_ctx.drawImage(prev,x1,y1,mw,mh,0,0,mw,mh);

    // 画像を解析してバーコード読み取り
    tmp.toBlob(function(blob){
      let reader = new FileReader();
      reader.onload=function(){
        let config={
          decoder: {
            readers: ["ean_reader","ean_8_reader"],
            multiple: true, // 複数バーコード認識を有効化
          },
          locator:{patchSize:"large",halfSample:false},
          locate:false,
          src:reader.result,
        };
        Quagga.decodeSingle(config,function(){});
      }
      reader.readAsDataURL(blob);
    });
    // 50msごとにスキャンを継続
    setTimeout(Scan,50,false);
  }

  // 2. 重构识别逻辑：按条码分组计数，去重后添加
  Quagga.onDetected(function (result) {
    const currentCode = result.codeResult.code;
    // スキップ条件：1. 既に認識済みの条码 2. 空の条码
    if (!currentCode || scannedCodes.has(currentCode)) {
      return;
    }

    // 各条码ごとにカウントを管理（防誤読）
    if (codeCounter[currentCode]) {
      codeCounter[currentCode]++; // 同じ条码ならカウント増加
    } else {
      // 新しい条码なら、他の条码のカウントをリセットして自身を初期化
      codeCounter = {};
      codeCounter[currentCode] = 1;
    }

    // 連続3回同じ条码を認識したら確定
    if (codeCounter[currentCode] >= 3) {
      console.log("バーコード確定：", currentCode);
      jan.value += currentCode + '\n';
      jan.scrollTop = jan.scrollHeight;
      scannedCodes.add(currentCode); // 認識済みとして登録（重複防止）
      codeCounter = {}; // カウンターリセット→次の条码を待機
    }
  });

  // 3. 清空按钮功能（追加：便利な操作のため）
  document.getElementById('clear-btn').addEventListener('click', function() {
    jan.value = '';
    scannedCodes.clear();
    codeCounter = {};
  });
});
</script>
<style>
/* レイアウト最適化：カメラ画面とtextareaを重ならないように */
#preview {
  margin-bottom: 15px;
  border: 1px solid #ddd;
}
#jan {
  width: 100%;
  max-width: 100%;
  padding: 8px;
  font-size: 16px;
  box-sizing: border-box;
}
#clear-btn {
  margin: 10px 0;
  padding: 8px 16px;
  font-size: 16px;
  cursor: pointer;
  background-color: #f0f0f0;
  border: 1px solid #ccc;
  border-radius: 4px;
}
</style>
</head>
<body>
  <div><canvas id="preview"></canvas></div>
  <button id="clear-btn">スキャン結果をクリア</button>
  <textarea id="jan" rows="8" cols="40"></textarea>
</body>
</html>
