<!DOCTYPE html>
<html lang="ja">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=0.1, maximum-scale=4,user-scalable=yes">
<!-- quaggaJSの読み込み -->
<script src="https://cdn.rawgit.com/serratus/quaggaJS/0420d5e0/dist/quagga.min.js"></script>
<style>
/* 新增：条码类型选择区样式，适配手机 */
.barcode-type-select {
  margin: 10px 0;
  padding: 8px;
  border: 1px solid #eee;
  border-radius: 4px;
}
.barcode-type-select label {
  display: inline-block;
  margin-right: 15px;
  cursor: pointer;
  font-size: 14px;
}
/* 优化textarea样式，避免被遮挡 */
#jan {
  width: 100%;
  box-sizing: border-box;
  padding: 8px;
  margin-top: 10px;
}
/* 优化canvas显示 */
#preview {
  max-width: 100%;
}
</style>
<script>
var DetectedCount=0,DetectedCode="";
var video,tmp,tmp_ctx,jan,prev,prev_ctx,w,h,mw,mh,x1,y1;
// 新增：存储当前选中的条码识别类型，默认Code128
var currentReader = "code_128_reader";

window.addEventListener('load',function(event){
  video=document.createElement('video');
  video.setAttribute("autoplay","");
  video.setAttribute("muted","");
  video.setAttribute("playsinline","");
  video.onloadedmetadata = function(e){video.play();};
  prev=document.getElementById("preview");
  prev_ctx=prev.getContext("2d", {willReadFrequently:true});
  tmp = document.createElement('canvas');
  tmp_ctx = tmp.getContext("2d", {willReadFrequently:true});
  jan=document.getElementById("jan");

  // 新增：初始化条码类型选择控件
  initBarcodeTypeSelect();

  // A permission dialog for camera access will appear
  navigator.mediaDevices.getUserMedia(
    // Microphone off, camera settings: prefer rear camera, prefer 640×480
    {"audio":false,"video":{"facingMode":"environment","width":{"ideal":640},"height":{"ideal":480}}}
  ).then( // When permission is granted
    function(stream){
      video.srcObject = stream;
      // Scan every 0.5 seconds
      setTimeout(Scan,500,true);
    }
  ).catch( // When permission is denied
    function(err){jan.value+=err+'\n';}
  );

  function Scan(first){
    if(first){
      // Selected width and height
      w=video.videoWidth;
      h=video.videoHeight;
      // Display size on screen
      prev.style.width=(w/2)+"px";
      prev.style.height=(h/2)+"px";
      // Internal canvas size
      prev.setAttribute("width",w);
      prev.setAttribute("height",h);
      mw=w*0.5;
      mh=w*0.2;
      x1=(w-mw)/2;
      y1=(h-mh)/2;
    }
    prev_ctx.drawImage(video,0,0,w,h);
    prev_ctx.beginPath();
    prev_ctx.strokeStyle="rgb(255,0,0)";
    prev_ctx.lineWidth=2;
    prev_ctx.rect(x1,y1,mw,mh);
    prev_ctx.stroke();
    tmp.setAttribute("width",mw);
    tmp.setAttribute("height",mh);
    tmp_ctx.drawImage(prev,x1,y1,mw,mh,0,0,mw,mh);

    tmp.toBlob(function(blob){
      let reader = new FileReader();
      reader.onload=function(){
        let config={
          decoder: {
            // 改动：使用当前选中的识别类型（默认code_128_reader）
            readers: [currentReader],
            multiple: false, // Do not decode multiple barcodes at once
          },
          locator:{patchSize:"large",halfSample:false},
          locate:false,
          src:reader.result,
        };
        Quagga.decodeSingle(config,function(){});
      }
      reader.readAsDataURL(blob);
    });
    setTimeout(Scan,50,false);
  }

  Quagga.onDetected(function (result) {
    // Because misreads are common, treat it as successful only if the same value appears 3 times in a row
    if(DetectedCode==result.codeResult.code){
      DetectedCount++;
    }else{
      DetectedCount=0;
      DetectedCode=result.codeResult.code;
    }
    if(DetectedCount>=3){
      console.log(result.codeResult.code);
      jan.value+=result.codeResult.code+'\n';
      jan.scrollTop=jan.scrollHeight;
      DetectedCode='';
      DetectedCount=0;
    }
  });

  // 新增：初始化条码类型选择控件
  function initBarcodeTypeSelect() {
    // 创建选择区容器
    const selectContainer = document.createElement('div');
    selectContainer.className = 'barcode-type-select';
    selectContainer.innerHTML = `
      <div style="font-size:16px;margin-bottom:5px;">选择识别类型（默认Code128）：</div>
      <label>
        <input type="radio" name="barcodeType" value="code_128_reader" checked> Code128
      </label>
      <label>
        <input type="radio" name="barcodeType" value="ean_reader"> EAN-13
      </label>
      <label>
        <input type="radio" name="barcodeType" value="ean_8_reader"> EAN-8
      </label>
    `;
    // 插入到canvas下方
    prev.parentNode.insertAfter(selectContainer, prev);

    // 绑定选择事件
    const radioButtons = document.querySelectorAll('input[name="barcodeType"]');
    radioButtons.forEach(radio => {
      radio.addEventListener('change', function() {
        currentReader = this.value;
        console.log("切换为识别类型：", currentReader);
        // 切换类型后重置计数，避免残留
        DetectedCount = 0;
        DetectedCode = "";
      });
    });
  }
});
</script>
</head>
<body>
  <div><canvas id="preview"></canvas></div>
  <textarea id="jan" rows="8" cols="40"></textarea>
</body>
</html>
