<!DOCTYPE html>
<html lang="ja">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=0.1, maximum-scale=4,user-scalable=yes">
<!-- quaggaJSの読み込み -->
<script src="https://cdn.rawgit.com/serratus/quaggaJS/0420d5e0/dist/quagga.min.js"></script>
<style>
/* 基础样式：确保布局清晰 */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}
body {
  padding: 10px;
  font-family: Arial, sans-serif;
}
/* 识别类型选择框 */
.type-select {
  margin: 10px 0;
  font-size: 14px;
}
/* 摄像头画布：强制显示，避免消失 */
#preview {
  border: 1px solid #ccc;
  min-width: 320px;
  min-height: 240px;
  margin: 10px 0;
  display: block !important;
}
/* 目标条码表格样式（HTML中直接显示） */
#targetBarcodeTable {
  width: 100%;
  border-collapse: collapse;
  margin: 15px 0;
  font-size: 12px;
}
#targetBarcodeTable td {
  border: 1px solid #ddd;
  padding: 5px 4px;
  text-align: center;
  white-space: nowrap;
}
/* 匹配高亮：黄色背景 */
#targetBarcodeTable td.highlight {
  background-color: #fff3cd !important;
  font-weight: bold;
  color: #d63384;
}
/* 结果文本域 */
#jan {
  width: 100%;
  min-height: 100px;
  padding: 8px;
  margin-top: 10px;
}
h4 {
  margin: 10px 0 5px 0;
  font-size: 15px;
}
</style>
<script>
var DetectedCount=0,DetectedCode="";
var video,tmp,tmp_ctx,jan,prev,prev_ctx,w,h,mw,mh,x1,y1;
var currentReader = "code_128_reader";
var audioContext;

window.addEventListener('load',function(event){
  // 获取核心元素
  prev=document.getElementById("preview");
  jan=document.getElementById("jan");
  
  // 创建识别类型选择框
  createBarcodeTypeSelect();

  // 初始化音频
  initAudioContext();

  // 初始化画布上下文
  prev_ctx=prev.getContext("2d", {willReadFrequently:true});
  tmp = document.createElement('canvas');
  tmp_ctx = tmp.getContext("2d", {willReadFrequently:true});

  // 初始化视频
  video=document.createElement('video');
  video.setAttribute("autoplay","");
  video.setAttribute("muted","");
  video.setAttribute("playsinline","");
  video.onloadedmetadata = function(e){video.play();};

  // 请求摄像头权限
  navigator.mediaDevices.getUserMedia(
    {"audio":false,"video":{"facingMode":"environment","width":{"ideal":640},"height":{"ideal":480}}}
  ).then(function(stream){
    video.srcObject = stream;
    setTimeout(Scan,500,true);
  }).catch(function(err){
    jan.value+=err+'\n';
  });

  // 扫描函数
  function Scan(first){
    if(first){
      w=video.videoWidth || 640; // 兜底尺寸
      h=video.videoHeight || 480;
      prev.style.width = (w/2) + "px";
      prev.style.height = (h/2) + "px";
      prev.width = w;
      prev.height = h;
      mw=w*0.5;
      mh=w*0.2;
      x1=(w-mw)/2;
      y1=(h-mh)/2;
    }
    // 绘制摄像头画面
    prev_ctx.drawImage(video,0,0,w,h);
    // 绘制扫描框
    prev_ctx.beginPath();
    prev_ctx.strokeStyle="rgb(255,0,0)";
    prev_ctx.lineWidth=2;
    prev_ctx.rect(x1,y1,mw,mh);
    prev_ctx.stroke();

    // 裁剪识别区域
    tmp.width=mw;
    tmp.height=mh;
    tmp_ctx.drawImage(prev,x1,y1,mw,mh,0,0,mw,mh);

    tmp.toBlob(function(blob){
      let reader = new FileReader();
      reader.onload=function(){
        let config={
          decoder: {
            readers: [currentReader],
            multiple: false,
          },
          locator:{patchSize:"large",halfSample:false},
          locate:false,
          src:reader.result,
        };
        Quagga.decodeSingle(config,function(){});
      }
      reader.readAsDataURL(blob);
    });
    setTimeout(Scan,50,false);
  }

  // 识别结果处理
  Quagga.onDetected(function (result) {
    const currentCode = result.codeResult.code;
    if(DetectedCode==currentCode){
      DetectedCount++;
    }else{
      DetectedCount=0;
      DetectedCode=currentCode;
    }
    if(DetectedCount>=3){
      jan.value+=currentCode+'\n';
      jan.scrollTop=jan.scrollHeight;
      
      // 高亮HTML表格中匹配的条码
      highlightMatchedBarcode(currentCode);
      // 播放提示音+粤语播报
      playBeepSound();
      speakCantonese(currentCode);

      DetectedCode='';
      DetectedCount=0;
    }
  });

  // 创建识别类型选择框
  function createBarcodeTypeSelect() {
    const selectDiv = document.createElement('div');
    selectDiv.className = 'type-select';
    selectDiv.innerHTML = `
      <h4>选择识别类型</h4>
      <label style="margin-right:10px;">
        <input type="radio" name="barcodeType" value="code_128_reader" checked> Code128
      </label>
      <label style="margin-right:10px;">
        <input type="radio" name="barcodeType" value="ean_reader"> EAN-13
      </label>
      <label>
        <input type="radio" name="barcodeType" value="ean_8_reader"> EAN-8
      </label>
    `;
    document.body.insertBefore(selectDiv, document.body.firstChild);

    document.querySelectorAll('input[name="barcodeType"]').forEach(radio => {
      radio.addEventListener('change', function() {
        currentReader = this.value;
        DetectedCount=0;
        DetectedCode="";
      });
    });
  }

  // 高亮HTML表格中匹配的单元格
  function highlightMatchedBarcode(code) {
    // 查找HTML表格中对应data-code的单元格
    const targetCell = document.querySelector(`#targetBarcodeTable td[data-code="${code}"]`);
    if (targetCell) {
      targetCell.classList.add('highlight');
    }
  }

  // 音频相关函数
  function initAudioContext() {
    try {
      window.AudioContext = window.AudioContext || window.webkitAudioContext;
      audioContext = new AudioContext();
    } catch (e) {
      console.warn("音频功能不支持：", e);
    }
  }

  function playBeepSound() {
    if (!audioContext) return;
    
    if (audioContext.state === 'suspended') {
      audioContext.resume();
    }

    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    oscillator.type = 'sine';
    oscillator.frequency.setValueAtTime(440, audioContext.currentTime);
    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
    
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    oscillator.start();
    oscillator.stop(audioContext.currentTime + 0.1);
  }

  function speakCantonese(code) {
    if (!('speechSynthesis' in window)) {
      console.warn("语音合成不支持");
      return;
    }

    window.speechSynthesis.cancel();

    const utterance = new SpeechSynthesisUtterance();
    utterance.text = `识别到条码：${code}`;
    utterance.lang = 'yue-HK';
    utterance.volume = 1;
    utterance.rate = 0.9;
    utterance.pitch = 1;

    window.speechSynthesis.speak(utterance);
  }
});
</script>
</head>
<body>
  <!-- 识别类型选择框会通过JS插入到这里（最顶部） -->
  
  <!-- 摄像头画布 -->
  <canvas id="preview"></canvas>

  <!-- 目标条码表格：直接写在HTML中，页面加载即显示 -->
  <h4>目标条码列表（识别匹配后变黄）</h4>
  <table id="targetBarcodeTable">
    <tr>
      <td data-code="P005849">P005849</td>
      <td data-code="0019885">0019885</td>
      <td data-code="0020554">0020554</td>
      <td data-code="0020560">0020560</td>
      <td data-code="0025095">0025095</td>
      <td data-code="0021609">0021609</td>
    </tr>
    <tr>
      <td data-code="0025091">0025091</td>
      <td data-code="0025111">0025111</td>
      <td data-code="0030830">0030830</td>
      <td data-code="0033390">0033390</td>
      <td data-code="0033393">0033393</td>
      <td data-code="0036973">0036973</td>
    </tr>
    <tr>
      <td data-code="0036974">0036974</td>
      <td data-code="0025115">0025115</td>
      <td data-code="0025122">0025122</td>
      <td data-code="0030827">0030827</td>
      <td data-code="0033384">0033384</td>
      <td data-code="0025116">0025116</td>
    </tr>
    <tr>
      <td data-code="0025126">0025126</td>
      <td data-code="0025127">0025127</td>
      <td data-code="0020417">0020417</td>
      <td data-code="0020418">0020418</td>
      <td data-code="0020419">0020419</td>
      <td data-code="0020420">0020420</td>
    </tr>
    <tr>
      <td data-code="0020421">0020421</td>
      <td data-code="0020422">0020422</td>
      <td data-code="0020423">0020423</td>
      <td data-code="0020424">0020424</td>
      <td data-code="0020425">0020425</td>
      <td data-code="0020426">0020426</td>
    </tr>
    <tr>
      <td data-code="0020427">0020427</td>
      <td data-code="0020428">0020428</td>
      <td data-code="0020430">0020430</td>
      <td data-code="0020431">0020431</td>
      <td data-code="0020432">0020432</td>
      <td data-code="0020433">0020433</td>
    </tr>
    <tr>
      <td data-code="0020434">0020434</td>
      <td data-code="0020435">0020435</td>
      <td data-code="0020437">0020437</td>
      <td data-code="0020438">0020438</td>
      <td data-code="0022517">0022517</td>
      <td data-code="0022518">0022518</td>
    </tr>
    <tr>
      <td data-code="0022519">0022519</td>
      <td data-code="0022520">0022520</td>
      <td data-code="0022521">0022521</td>
      <td data-code="0022522">0022522</td>
      <td data-code="0022523">0022523</td>
      <td data-code="0022524">0022524</td>
    </tr>
    <tr>
      <td data-code="0044713">0044713</td>
      <td data-code="0044714">0044714</td>
      <td data-code="0033632">0033632</td>
      <td data-code="0033630">0033630</td>
      <td data-code="0034128">0034128</td>
      <td data-code="0026156">0026156</td>
    </tr>
    <tr>
      <td data-code="0033627">0033627</td>
      <td data-code="0033624">0033624</td>
      <td data-code="0033623">0033623</td>
      <td data-code="0033640">0033640</td>
      <td data-code="0033638">0033638</td>
      <td data-code="0033637">0033637</td>
    </tr>
    <tr>
      <td data-code="0036503">0036503</td>
      <td data-code="0036504">0036504</td>
      <td data-code="0036505">0036505</td>
      <td data-code="0036506">0036506</td>
      <td data-code="0036287">0036287</td>
      <td data-code="0036288">0036288</td>
    </tr>
    <tr>
      <td data-code="0036286">0036286</td>
      <td data-code="0036289">0036289</td>
      <td data-code="0036875">0036875</td>
      <td data-code="0036876">0036876</td>
      <td data-code="0036074">0036074</td>
      <td data-code="0036051">0036051</td>
    </tr>
    <tr>
      <td data-code="0026361">0026361</td>
      <td data-code="0026362">0026362</td>
      <td data-code="0031385">0031385</td>
      <td data-code="0031846">0031846</td>
      <td data-code="0031845">0031845</td>
      <td data-code="0036748">0036748</td>
    </tr>
    <tr>
      <td data-code="0032217">0032217</td>
      <td data-code="0032469">0032469</td>
      <td data-code="0036068">0036068</td>
      <td data-code="0019141">0019141</td>
      <td data-code="0019145">0019145</td>
      <td data-code="0019147">0019147</td>
    </tr>
    <tr>
      <td data-code="0019148">0019148</td>
      <td data-code="0021619">0021619</td>
      <td data-code="0021620">0021620</td>
      <td data-code="0017643">0017643</td>
      <td data-code="0019944">0019944</td>
      <td data-code="0031167">0031167</td>
    </tr>
    <tr>
      <td data-code="0031168">0031168</td>
      <td data-code="0031175">0031175</td>
      <td data-code="0031155">0031155</td>
      <td data-code="0031149">0031149</td>
      <td data-code="0031170">0031170</td>
      <td data-code="0027946">0027946</td>
    </tr>
    <tr>
      <td data-code="0027948">0027948</td>
      <td data-code="0031221">0031221</td>
      <td data-code="0033396">0033396</td>
      <td data-code="0033397">0033397</td>
      <td data-code="0033398">0033398</td>
      <td data-code="0031851">0031851</td>
    </tr>
    <tr>
      <td data-code="0031852">0031852</td>
      <td data-code="0018142">0018142</td>
      <td data-code="0024848">0024848</td>
      <td data-code="0024849">0024849</td>
      <td data-code="0024854">0024854</td>
      <td data-code="0024855">0024855</td>
    </tr>
    <tr>
      <td data-code="0024856">0024856</td>
      <td data-code="0022287">0022287</td>
      <td data-code="0036279">0036279</td>
      <td data-code="0036280">0036280</td>
      <td data-code="P005403">P005403</td>
      <td data-code="P005440">P005440</td>
    </tr>
    <tr>
      <td data-code="P005448">P005448</td>
      <td data-code="P005438">P005438</td>
      <td data-code="P005481">P005481</td>
      <td data-code="P005496">P005496</td>
      <td data-code="P005502">P005502</td>
      <td data-code="0026679">0026679</td>
    </tr>
    <tr>
      <td data-code="0031703">0031703</td>
      <td data-code="0031758">0031758</td>
      <td data-code="0031727">0031727</td>
      <td data-code="0031698">0031698</td>
      <td data-code="0017591">0017591</td>
      <td data-code="0020782">0020782</td>
    </tr>
    <tr>
      <td data-code="0022318">0022318</td>
      <td data-code="0036282">0036282</td>
      <td data-code="0036283">0036283</td>
      <td data-code="0036284">0036284</td>
      <td data-code="0019954">0019954</td>
      <td data-code="0020750">0020750</td>
    </tr>
    <tr>
      <td data-code="0023739">0023739</td>
      <td data-code="0023740">0023740</td>
      <td data-code="0018144">0018144</td>
      <td data-code="0019953">0019953</td>
      <td data-code="0022234">0022234</td>
      <td data-code="0022235">0022235</td>
    </tr>
    <tr>
      <td data-code="0026356">0026356</td>
      <td data-code="L002365">L002365</td>
      <td data-code="0032130">0032130</td>
      <td data-code="0033512">0033512</td>
      <td data-code="0036310">0036310</td>
      <td data-code="0033633">0033633</td>
    </tr>
    <tr>
      <td data-code="0022275">0022275</td>
      <td data-code="0022276">0022276</td>
      <td data-code="0015684">0015684</td>
      <td data-code="0022324">0022324</td>
      <td data-code="0022333">0022333</td>
      <td data-code="0032135">0032135</td>
    </tr>
    <tr>
      <td data-code="0032136">0032136</td>
    </tr>
  </table>

  <!-- 识别结果文本域 -->
  <textarea id="jan" rows="8" cols="40" placeholder="识别到的条码会显示在这里..."></textarea>
</body>
</html>
