<!DOCTYPE html>
<html lang="ja">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=0.1, maximum-scale=4,user-scalable=yes">
<!-- quaggaJSの読み込み -->
<script src="https://cdn.rawgit.com/serratus/quaggaJS/0420d5e0/dist/quagga.min.js"></script>
<script>
// 简化变量：仅保留必要的去重集合
var scannedCodes = new Set(); 
var video, tmp, tmp_ctx, jan, prev, prev_ctx, w, h, mw, mh, x1, y1;

window.addEventListener('load',function(event){
  video=document.createElement('video');
  video.setAttribute("autoplay","");
  video.setAttribute("muted","");
  video.setAttribute("playsinline","");
  video.onloadedmetadata = function(e){video.play();};
  prev=document.getElementById("preview");
  prev_ctx=prev.getContext("2d", {willReadFrequently:true});
  tmp = document.createElement('canvas');
  tmp_ctx = tmp.getContext("2d", {willReadFrequently:true});
  jan=document.getElementById("jan");

  // カメラ権限リクエスト
  navigator.mediaDevices.getUserMedia(
    {"audio":false,"video":{"facingMode":"environment","width":{"ideal":640},"height":{"ideal":480}}}
  ).then(function(stream){
    video.srcObject = stream;
    setTimeout(Scan,500,true);
  }).catch(function(err){
    jan.value += "カメラ権限エラー：" + err + '\n';
  });

  function Scan(first){
    if(first){
      w=video.videoWidth;
      h=video.videoHeight;
      prev.style.width=(w/2)+"px";
      prev.style.height=(h/2)+"px";
      prev.setAttribute("width",w);
      prev.setAttribute("height",h);
      mw=w*0.5;
      mh=w*0.2;
      x1=(w-mw)/2;
      y1=(h-mh)/2;
    }
    // 描画カメラ画面とスキャン枠
    prev_ctx.drawImage(video,0,0,w,h);
    prev_ctx.beginPath();
    prev_ctx.strokeStyle="rgb(255,0,0)";
    prev_ctx.lineWidth=2;
    prev_ctx.rect(x1,y1,mw,mh);
    prev_ctx.stroke();
    tmp.setAttribute("width",mw);
    tmp.setAttribute("height",mh);
    tmp_ctx.drawImage(prev,x1,y1,mw,mh,0,0,mw,mh);

    // 核心修改1：移除multiple: true（decodeSingle不兼容多码模式）
    // 改为单次识别单码，但通过循环+去重实现多码连续识别
    tmp.toBlob(function(blob){
      let reader = new FileReader();
      reader.onload=function(){
        let config={
          decoder: {
            readers: ["ean_reader","ean_8_reader"],
            multiple: false, // 改回false，保证decodeSingle能正常识别
          },
          locator:{patchSize:"large",halfSample:true}, // 改halfSample为true，提升识别速度
          locate:true, // 开启定位，帮助识别
          src:reader.result,
        };
        Quagga.decodeSingle(config, function(result) {
          // 核心修改2：直接在decodeSingle的回调中处理识别结果（更稳定）
          if (result && result.codeResult && result.codeResult.code) {
            handleDetectedCode(result.codeResult.code);
          }
        });
      }
      reader.readAsDataURL(blob);
    });
    setTimeout(Scan, 200, false); // 延长扫描间隔到200ms，减少性能消耗
  }

  // 简化的识别处理函数
  function handleDetectedCode(code) {
    // 去重：仅添加未识别过的条码
    if (!scannedCodes.has(code)) {
      console.log("バーコード認識：", code);
      jan.value += code + '\n';
      jan.scrollTop = jan.scrollHeight;
      scannedCodes.add(code); // 标记为已识别
    }
  }

  // 清空按钮
  document.getElementById('clear-btn').addEventListener('click', function() {
    jan.value = '';
    scannedCodes.clear();
  });
});
</script>
<style>
#preview {
  margin-bottom: 15px;
  border: 1px solid #ddd;
}
#jan {
  width: 100%;
  max-width: 100%;
  padding: 8px;
  font-size: 16px;
  box-sizing: border-box;
}
#clear-btn {
  margin: 10px 0;
  padding: 8px 16px;
  font-size: 16px;
  cursor: pointer;
  background-color: #f0f0f0;
  border: 1px solid #ccc;
  border-radius: 4px;
}
</style>
</head>
<body>
  <div><canvas id="preview"></canvas></div>
  <button id="clear-btn">スキャン結果をクリア</button>
  <textarea id="jan" rows="8" cols="40"></textarea>
</body>
</html>
