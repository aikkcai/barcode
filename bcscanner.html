<!DOCTYPE html>
<html lang="ja">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=0.1, maximum-scale=4,user-scalable=yes">
<!-- quaggaJSの読み込み -->
<script src="https://cdn.rawgit.com/serratus/quaggaJS/0420d5e0/dist/quagga.min.js"></script>
<script>
var DetectedCount=0,DetectedCode="";
var video,tmp,tmp_ctx,jan,prev,prev_ctx,w,h,mw,mh,x1,y1;
var currentReader = "code_128_reader";
// 新增：创建音频上下文和提示音
var audioContext;

window.addEventListener('load',function(event){
  prev=document.getElementById("preview");
  jan=document.getElementById("jan");
  
  createBarcodeTypeSelect();

  // 新增：初始化音频上下文（解决浏览器音频策略限制）
  initAudioContext();

  prev_ctx=prev.getContext("2d", {willReadFrequently:true});
  tmp = document.createElement('canvas');
  tmp_ctx = tmp.getContext("2d", {willReadFrequently:true});

  video=document.createElement('video');
  video.setAttribute("autoplay","");
  video.setAttribute("muted","");
  video.setAttribute("playsinline","");
  video.onloadedmetadata = function(e){video.play();};

  navigator.mediaDevices.getUserMedia(
    {"audio":false,"video":{"facingMode":"environment","width":{"ideal":640},"height":{"ideal":480}}}
  ).then(function(stream){
    video.srcObject = stream;
    setTimeout(Scan,500,true);
  }).catch(function(err){
    jan.value+=err+'\n';
  });

  function Scan(first){
    if(first){
      w=video.videoWidth;
      h=video.videoHeight;
      prev.style.width = (w/2) + "px";
      prev.style.height = (h/2) + "px";
      prev.width = w;
      prev.height = h;
      mw=w*0.5;
      mh=w*0.2;
      x1=(w-mw)/2;
      y1=(h-mh)/2;
    }
    prev_ctx.drawImage(video,0,0,w,h);
    prev_ctx.beginPath();
    prev_ctx.strokeStyle="rgb(255,0,0)";
    prev_ctx.lineWidth=2;
    prev_ctx.rect(x1,y1,mw,mh);
    prev_ctx.stroke();

    tmp.width=mw;
    tmp.height=mh;
    tmp_ctx.drawImage(prev,x1,y1,mw,mh,0,0,mw,mh);

    tmp.toBlob(function(blob){
      let reader = new FileReader();
      reader.onload=function(){
        let config={
          decoder: {
            readers: [currentReader],
            multiple: false,
          },
          locator:{patchSize:"large",halfSample:false},
          locate:false,
          src:reader.result,
        };
        Quagga.decodeSingle(config,function(){});
      }
      reader.readAsDataURL(blob);
    });
    setTimeout(Scan,50,false);
  }

  Quagga.onDetected(function (result) {
    const currentCode = result.codeResult.code;
    if(DetectedCode==currentCode){
      DetectedCount++;
    }else{
      DetectedCount=0;
      DetectedCode=currentCode;
    }
    if(DetectedCount>=3){
      console.log(result.codeResult.code);
      jan.value+=currentCode+'\n';
      jan.scrollTop=jan.scrollHeight;
      
      // 新增：识别成功后播放提示音+粤语播报
      playBeepSound();
      speakCantonese(currentCode);

      DetectedCode='';
      DetectedCount=0;
    }
  });

  function createBarcodeTypeSelect() {
    const selectDiv = document.createElement('div');
    selectDiv.style.margin = "10px 0";
    selectDiv.style.fontSize = "14px";
    selectDiv.innerHTML = `
      <div style="margin-bottom:5px;">识别类型：</div>
      <label style="margin-right:10px;">
        <input type="radio" name="barcodeType" value="code_128_reader" checked> Code128
      </label>
      <label style="margin-right:10px;">
        <input type="radio" name="barcodeType" value="ean_reader"> EAN-13
      </label>
      <label>
        <input type="radio" name="barcodeType" value="ean_8_reader"> EAN-8
      </label>
    `;
    document.body.insertBefore(selectDiv, prev.parentNode);

    document.querySelectorAll('input[name="barcodeType"]').forEach(radio => {
      radio.addEventListener('change', function() {
        currentReader = this.value;
        DetectedCount=0;
        DetectedCode="";
      });
    });
  }

  // 新增1：初始化音频上下文（解决浏览器自动播放限制）
  function initAudioContext() {
    try {
      window.AudioContext = window.AudioContext || window.webkitAudioContext;
      audioContext = new AudioContext();
    } catch (e) {
      console.warn("音频功能不支持：", e);
    }
  }

  // 新增2：播放BIT提示音（纯代码生成，无需外部音频文件）
  function playBeepSound() {
    if (!audioContext) return;
    
    // 重启音频上下文（解决浏览器暂停策略）
    if (audioContext.state === 'suspended') {
      audioContext.resume();
    }

    // 创建440Hz的提示音（BIT声）
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    oscillator.type = 'sine'; // 正弦波，音质更清脆
    oscillator.frequency.setValueAtTime(440, audioContext.currentTime); // 440Hz = A调
    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime); // 音量（0-1）
    
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    // 播放100ms
    oscillator.start();
    oscillator.stop(audioContext.currentTime + 0.1);
  }

  // 新增3：粤语语音播报条码数字
  function speakCantonese(code) {
    // 检查浏览器是否支持语音合成
    if (!('speechSynthesis' in window)) {
      console.warn("语音合成不支持");
      return;
    }

    // 清空之前的播报队列
    window.speechSynthesis.cancel();

    // 创建语音播报实例
    const utterance = new SpeechSynthesisUtterance();
    utterance.text = `识别到条码：${code}`;
    utterance.lang = 'yue-HK'; // 粤语（香港）
    utterance.volume = 1; // 音量（0-1）
    utterance.rate = 0.9; // 语速（0.1-10）
    utterance.pitch = 1; // 音调（0-2）

    // 播放语音
    window.speechSynthesis.speak(utterance);
  }
});
</script>
</head>
<body>
  <div><canvas id="preview"></canvas></div>
  <textarea id="jan" rows="8" cols="40"></textarea>
</body>
</html>
